Ok, mình xem nhanh ảnh test + code của bạn rồi. Vấn đề chính: win-rate ~54% nhưng PF ~0.74 vì lợi nhuận trung bình/1 lệnh thắng (≈ +5 pip) nhỏ hơn lỗ trung bình/1 lệnh thua (≈ −8 pip) ⇒ kỳ vọng âm. (PF = (0.5419×5.01)/(0.4581×8.03) ≈ 0.74). Muốn PF>1, với L≈8 pip thì W phải ≥ ~8–12 pip tùy win-rate (ví dụ w=0.50 ⇒ W≈≥10 pip; w=0.45 ⇒ W≈≥12 pip).

Dưới đây là checklist ngắn + thông số gợi ý để “đẩy” W/L lên:

Chẩn đoán nhanh

TP/thực thu quá nhỏ: phần lớn lệnh thắng bị cắt sớm bởi trailing/BE → chỉ còn ~+5 pip, trong khi lệnh thua mất ~8 pip.

BE đang xa hoặc logic cắt sớm chưa đúng với “Quick Scalp Mode”. Trong README bạn mô tả BE +3 pip, TP cố định 40 pip, QuickExit tắt để cho lệnh chạy tự nhiên 

PTG_STRATEGY_COMPLETE_GUIDE

; nhưng ảnh cấu hình lại để BE=20, QuickExit=50 → không đúng ý tưởng scalping ban đầu.

Bug/logic nhỏ trong code:

Bạn luôn đặt TP = QuickExitPips cả khi UseQuickExit=false (trong ExecuteYoloTrade), nên lệnh vẫn bị “đụng trần” TP.

Sau khi BE, bạn không cập nhật last_trail_level → lần gọi kế tiếp có thể nhảy SL chưa mượt.

Kiểm tra spread: bạn đang so sánh points với biến đặt tên “pips”. Nên quy đổi spread về pips = (ask-bid)/pip_size để filter chuẩn.

Bộ thông số đề xuất (đi từ dễ → khó)

Bạn hãy test 3 preset này trên M1 XAUUSD (Every tick, cùng data), chọn preset nào cho PF ≥1.1–1.3 và equity curve mượt.

A. Quick-Scalp (ưu tiên PF)

UseQuickExit = true

BreakevenPips = 3–4

Sweep QuickExitPips = 12, 14, 16, 18, 20

TrailStepPips = 8–10, MinProfitPips = 3–4

Mục tiêu: W thực tế ~10–14 pip để vượt L≈8 pip → PF dương.

B. Trail-Runner (không giới hạn TP)

UseQuickExit = false

Quan trọng: không đặt TP khi UseQuickExit=false (sửa code ở dưới).

BreakevenPips = 3–5

TrailStepPips = 12–14, MinProfitPips = 4–5
(ví dụ ở +12p → SL = +8p; ở +24p → SL = +20p)

Mục tiêu: cắt lỗ nhỏ, kéo dài lệnh thắng để nâng W lên ≥12–15 pip.

C. Hybrid 2 nấc (an toàn + vẫn có runner)

Khi đạt TP1 = +10–12p: chốt 50% khối lượng + dời SL về entry.

Phần còn lại: trailing như preset B; tùy chọn TP2 = 28–35p.

Cách này làm W trung bình tăng đáng kể mà không cần win-rate cao.

Sửa code ngắn gọn (rất nên làm)

1. Đừng gắn TP khi tắt QuickExit
// Trong ExecuteYoloTrade(...)
request.tp = UseQuickExit ? NormalizeDouble(tp_price, Digits()) : 0.0;

2. Đồng bộ trạng thái trail sau BE
// Trong MoveSLToEntry(...)
if (OrderSend(request, result)) {
    pip_breakeven_activated = true;
    last_trail_level = BreakevenPips;   // để bước trail tiếp theo bắt đầu “đúng bậc”
}

3. Spread theo pips (chuẩn hóa)
double spread_pips = (SymbolInfoDouble(Symbol(), SYMBOL_ASK)
                    - SymbolInfoDouble(Symbol(), SYMBOL_BID)) / pip_size;
if (spread_pips > MaxSpreadPips) return false;

4. (Tuỳ chọn) Partial close cho preset C:
void PartialClose(double fraction){
   if(!PositionSelect(Symbol())) return;
   double vol = PositionGetDouble(POSITION_VOLUME);
   double closeVol = MathMax(SymbolInfoDouble(Symbol(), SYMBOL_VOLUME_MIN),
                             MathFloor(vol*fraction / SymbolInfoDouble(Symbol(), SYMBOL_VOLUME_STEP))
                             * SymbolInfoDouble(Symbol(), SYMBOL_VOLUME_STEP));
   // gửi lệnh CLOSE phần closeVol...
}

Cách tối ưu TP nhanh trong MT5

Bật Optimization, chạy lưới:
QuickExitPips = 10..30 (step 2), BreakevenPips = 3..5, TrailStepPips = 8..14 (step 2), MinProfitPips = 3..5.

Tiêu chí chọn: Profit Factor (>=1.2) → Net Profit → Max DD thấp → số lệnh đủ lớn.

Xác nhận lại bằng out-of-sample (tuần/khoảng thời gian khác).

Vì sao làm vậy?

Với dữ liệu test của bạn: W≈5 < L≈8 nên âm. Đẩy BE sớm (3–5p) + TP thực thi 12–20p hoặc trailing rộng sẽ kéo W/L > 1, trong khi win-rate của PTG vốn ~44–52% (theo README) nên PF có thể vượt 1 khi TP/Trail hợp lý. 

PTG_STRATEGY_COMPLETE_GUIDE

-> Nếu bạn muốn, mình có thể viết sẵn .set cho 3 preset trên hoặc thêm logging CSV (run-up/MAE/MFE) để bạn nhìn rõ W/L theo từng mức TP.
