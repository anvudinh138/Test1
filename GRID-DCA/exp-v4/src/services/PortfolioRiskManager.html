//+------------------------------------------------------------------+
//|                                    PortfolioRiskManager.mqh    |
//|                                       FlexGridDCA EA v3.0.0      |
//|                                Portfolio-Level Risk Management  |
//+------------------------------------------------------------------+
#property copyright "FlexGridDCA EA v3.0"
#property version   "1.00"

//+------------------------------------------------------------------+
//| Portfolio Risk Manager - CRITICAL SAFETY SYSTEM               |
//+------------------------------------------------------------------+
class CPortfolioRiskManager
{
private:
    // Risk limits
    double              m_max_portfolio_risk;
    double              m_max_drawdown_percent;
    double              m_initial_balance;
    
    // Tracking
    double              m_peak_equity;
    datetime            m_last_risk_check;
    
    // Risk calculations
    double              m_current_portfolio_risk;
    double              m_current_drawdown_percent;
    
    // Emergency flags
    bool                m_emergency_mode;
    string              m_emergency_reason;
    
public:
    //+------------------------------------------------------------------+
    //| Constructor                                                      |
    //+------------------------------------------------------------------+
    CPortfolioRiskManager()
    {
        m_max_portfolio_risk = 500.0;
        m_max_drawdown_percent = 20.0;
        m_initial_balance = 0.0;
        m_peak_equity = 0.0;
        m_last_risk_check = 0;
        m_current_portfolio_risk = 0.0;
        m_current_drawdown_percent = 0.0;
        m_emergency_mode = false;
        m_emergency_reason = "";
    }
    
    //+------------------------------------------------------------------+
    //| Initialize Risk Manager                                        |
    //+------------------------------------------------------------------+
    bool Initialize(double max_portfolio_risk, double max_drawdown_percent, double initial_balance)
    {
        m_max_portfolio_risk = max_portfolio_risk;
        m_max_drawdown_percent = max_drawdown_percent;
        m_initial_balance = initial_balance;
        m_peak_equity = initial_balance;
        
        Print("ðŸ›¡ï¸ PORTFOLIO RISK MANAGER INITIALIZED");
        Print("ðŸ›¡ï¸ Max Portfolio Risk: $", DoubleToString(m_max_portfolio_risk, 2));
        Print("ðŸ›¡ï¸ Max Drawdown: ", DoubleToString(m_max_drawdown_percent, 1), "%");
        Print("ðŸ›¡ï¸ Initial Balance: $", DoubleToString(m_initial_balance, 2));
        
        return true;
    }
    
    //+------------------------------------------------------------------+
    //| Check Portfolio Risk - MAIN SAFETY FUNCTION                   |
    //+------------------------------------------------------------------+
    bool CheckPortfolioRisk(double total_lifecycle_risk)
    {
        double current_equity = AccountInfoDouble(ACCOUNT_EQUITY);
        double current_balance = AccountInfoDouble(ACCOUNT_BALANCE);
        
        // Update peak equity
        if(current_equity > m_peak_equity)
        {
            m_peak_equity = current_equity;
        }
        
        // Calculate current portfolio risk
        m_current_portfolio_risk = total_lifecycle_risk;
        
        // Calculate current drawdown
        m_current_drawdown_percent = ((m_peak_equity - current_equity) / m_peak_equity) * 100.0;
        
        // Check portfolio risk limit
        if(m_current_portfolio_risk > m_max_portfolio_risk)
        {
            TriggerEmergency(StringFormat("Portfolio Risk Limit Exceeded: $%.2f > $%.2f", 
                                        m_current_portfolio_risk, m_max_portfolio_risk));
            return false;
        }
        
        // Check drawdown limit
        if(m_current_drawdown_percent > m_max_drawdown_percent)
        {
            TriggerEmergency(StringFormat("Drawdown Limit Exceeded: %.1f%% > %.1f%%", 
                                        m_current_drawdown_percent, m_max_drawdown_percent));
            return false;
        }
        
        // Check margin level
        double margin_level = AccountInfoDouble(ACCOUNT_MARGIN_LEVEL);
        if(margin_level < 200.0 && margin_level > 0)
        {
            TriggerEmergency(StringFormat("Critical Margin Level: %.1f%%", margin_level));
            return false;
        }
        
        // Check account equity vs balance (major loss detection)
        double equity_vs_balance_percent = (current_equity / current_balance) * 100.0;
        if(equity_vs_balance_percent < 80.0) // 20% loss from balance
        {
            TriggerEmergency(StringFormat("Major Account Loss: Equity %.1f%% of Balance", 
                                        equity_vs_balance_percent));
            return false;
        }
        
        return true; // All checks passed
    }
    
    //+------------------------------------------------------------------+
    //| Advanced Risk Calculations                                     |
    //+------------------------------------------------------------------+
    double CalculateRiskPercentage()
    {
        double current_equity = AccountInfoDouble(ACCOUNT_EQUITY);
        if(current_equity <= 0) return 100.0;
        
        return (m_current_portfolio_risk / current_equity) * 100.0;
    }
    
    double GetMaxAllowableRisk()
    {
        return m_max_portfolio_risk;
    }
    
    double GetRemainingRiskCapacity()
    {
        return m_max_portfolio_risk - m_current_portfolio_risk;
    }
    
    bool CanAllocateRisk(double additional_risk)
    {
        return (m_current_portfolio_risk + additional_risk) <= m_max_portfolio_risk;
    }
    
    //+------------------------------------------------------------------+
    //| Emergency Management                                           |
    //+------------------------------------------------------------------+
    void TriggerEmergency(string reason)
    {
        m_emergency_mode = true;
        m_emergency_reason = reason;
        
        Print("ðŸš¨ðŸš¨ðŸš¨ PORTFOLIO RISK MANAGER EMERGENCY ðŸš¨ðŸš¨ðŸš¨");
        Print("ðŸš¨ REASON: ", reason);
        Print("ðŸš¨ Current Portfolio Risk: $", DoubleToString(m_current_portfolio_risk, 2));
        Print("ðŸš¨ Current Drawdown: ", DoubleToString(m_current_drawdown_percent, 1), "%");
        Print("ðŸš¨ EMERGENCY SHUTDOWN REQUIRED");
    }
    
    void ResetEmergency()
    {
        m_emergency_mode = false;
        m_emergency_reason = "";
        Print("âœ… Portfolio Risk Manager Emergency Reset");
    }
    
    //+------------------------------------------------------------------+
    //| Portfolio Health Assessment                                    |
    //+------------------------------------------------------------------+
    string GetPortfolioHealthStatus()
    {
        double current_equity = AccountInfoDouble(ACCOUNT_EQUITY);
        double risk_percentage = CalculateRiskPercentage();
        
        string health_status = "";
        
        if(m_emergency_mode)
        {
            health_status = "EMERGENCY";
        }
        else if(risk_percentage > 80.0)
        {
            health_status = "CRITICAL";
        }
        else if(risk_percentage > 60.0)
        {
            health_status = "HIGH RISK";
        }
        else if(risk_percentage > 40.0)
        {
            health_status = "MODERATE";
        }
        else if(risk_percentage > 20.0)
        {
            health_status = "LOW RISK";
        }
        else
        {
            health_status = "HEALTHY";
        }
        
        return StringFormat("%s (Risk: %.1f%% | DD: %.1f%%)", 
                           health_status, risk_percentage, m_current_drawdown_percent);
    }
    
    //+------------------------------------------------------------------+
    //| Getters                                                        |
    //+------------------------------------------------------------------+
    bool IsEmergencyMode() { return m_emergency_mode; }
    string GetEmergencyReason() { return m_emergency_reason; }
    double GetCurrentPortfolioRisk() { return m_current_portfolio_risk; }
    double GetCurrentDrawdownPercent() { return m_current_drawdown_percent; }
    double GetPeakEquity() { return m_peak_equity; }
    
    //+------------------------------------------------------------------+
    //| Risk Metrics for Dashboard                                     |
    //+------------------------------------------------------------------+
    string GetRiskMetricsString()
    {
        return StringFormat("Risk: $%.2f/$%.2f (%.1f%%) | DD: %.1f%%/%.1f%% | Health: %s",
                           m_current_portfolio_risk, m_max_portfolio_risk, CalculateRiskPercentage(),
                           m_current_drawdown_percent, m_max_drawdown_percent,
                           GetPortfolioHealthStatus());
    }
    
    //+------------------------------------------------------------------+
    //| Lifecycle Risk Allocation                                      |
    //+------------------------------------------------------------------+
    double GetRecommendedLifecycleRisk(int active_lifecycle_count)
    {
        if(active_lifecycle_count <= 0) return 0.0;
        
        double available_risk = GetRemainingRiskCapacity();
        double recommended_per_lifecycle = available_risk / (active_lifecycle_count + 1); // +1 for buffer
        
        // Cap at reasonable limits
        double max_per_lifecycle = m_max_portfolio_risk * 0.3; // Max 30% per lifecycle
        
        return MathMin(recommended_per_lifecycle, max_per_lifecycle);
    }
    
    bool ValidateLifecycleRiskAllocation(double lifecycle_risk, int total_lifecycles)
    {
        // Check if this allocation is safe
        double total_if_all_same = lifecycle_risk * total_lifecycles;
        
        return total_if_all_same <= m_max_portfolio_risk * 0.8; // 80% safety margin
    }
};

//+------------------------------------------------------------------+
