//@version=6
strategy("PTG Exness Zero – 0 Spread, Commission", overlay=true, max_bars_back=200, 
         default_qty_type=strategy.percent_of_equity, default_qty_value=100,
         commission_type=strategy.commission.cash_per_contract, commission_value=0.35,
         calc_on_every_tick=true)

// ===== Exness Zero Account Settings =====
// Spread: 0 pip (raw spread)
// Commission: ~$0.35 per lot per side for XAUUSD (round turn = $0.70)
// Better for high volume trading

pipSize     = input.float(0.01, "Pip size (XAUUSD=0.01)", step=0.01)
useEMA      = input.bool(true,  "Lọc trend EMA34/55")
useVWAP     = input.bool(false, "Lọc trend VWAP (turn OFF for more signals)")
lookback    = input.int(20,  "So sánh trong N nến", minval=10)

// Optimized parameters - need bigger TPs to cover commission
pushRangePct= input.float(0.65,"Range ≥ 65% range lớn nhất N nến", step=0.05)
closePct    = input.float(0.65,"Close nằm ở 65–100% cực trị", step=0.05)
oppWickPct  = input.float(0.35,"Bóng ngược ≤ 35% range", step=0.05)
volHighMult = input.float(1.4, "Vol ≥ 1.4× SMA Vol", step=0.1)

testBars    = input.int(3, "Cho phép TEST trong 1–3 nến", minval=1, maxval=5)
pullbackMax = input.float(0.40,"Pullback ≤ 40% range PUSH", step=0.02)
volLowMult  = input.float(0.9, "Vol TEST ≤ 0.9× SMA Vol", step=0.05)

entryBufPip = input.float(0.01, "Đệm Entry (pip) - 0 spread", step=0.01)
slBufPip    = input.float(0.02, "Đệm SL (pip)", step=0.01)

// Strategy settings - need bigger TPs for Zero account
riskPercent = input.float(100.0, "Risk per trade (%) - FULL MARGIN YOLO", step=10.0, minval=10.0, maxval=100.0)
usePartialTPs = input.bool(false, "Use partial TPs (keep simple for scalping)")
tpMultiplier = input.float(2.0, "TP multiplier (2.0 = 2 pip TP to cover commission)", step=0.5, minval=1.0, maxval=5.0)

// ===== Core Logic (Same as Pro) =====
ema34 = ta.ema(close, 34)
ema55 = ta.ema(close, 55)
vwap  = ta.vwap

upOK = (not useEMA or ema34 > ema55) and (not useVWAP or close > vwap)
dnOK = (not useEMA or ema34 < ema55) and (not useVWAP or close < vwap)

rng   = high - low
rngHi = ta.highest(rng, lookback)
volMA = ta.sma(volume, lookback)
rngMA = ta.sma(rng, lookback)

closePosHi = (close - low) / math.max(rng, 1e-6)
closePosLo = (high - close) / math.max(rng, 1e-6)
lowWick    = (math.min(open, close) - low) / math.max(rng, 1e-6)
upWick     = (high - math.max(open, close)) / math.max(rng, 1e-6)

bigRange = rng >= rngHi * pushRangePct
hiVol    = volume >= volMA * volHighMult and volume > volume[1]

// Push detection
pushUp = upOK and bigRange and hiVol and closePosHi >= closePct and upWick <= oppWickPct
pushDn = dnOK and bigRange and hiVol and closePosLo >= closePct and lowWick <= oppWickPct

plotshape(pushUp, title="Push Up", style=shape.triangleup, location=location.belowbar,
     color=color.new(color.lime, 0), size=size.tiny, text="P↑", textcolor=color.black)
plotshape(pushDn, title="Push Down", style=shape.triangledown, location=location.abovebar,
     color=color.new(color.red, 0), size=size.tiny, text="P↓", textcolor=color.white)

var bool  waitTest = false
var bool  longDir  = false
var int   iPush    = na
var float hiPush   = na
var float loPush   = na
var float rngPush  = na

if (pushUp or pushDn)
    waitTest := true
    longDir  := pushUp
    iPush    := bar_index
    hiPush   := high
    loPush   := low
    rngPush  := rng

win = waitTest and (bar_index - iPush) >= 1 and (bar_index - iPush) <= testBars

pullOKLong  = win and  longDir     and (hiPush - low)  <= pullbackMax * rngPush
pullOKShort = win and (not longDir) and (high  - loPush) <= pullbackMax * rngPush
lowVol      = volume <= volMA * volLowMult
smallRng    = rng <= rngMA * 0.8

testLong  = pullOKLong  and lowVol and smallRng
testShort = pullOKShort and lowVol and smallRng

plotshape(testLong,  title="Test Long",  style=shape.circle, location=location.belowbar,
     color=color.new(color.lime, 0), size=size.tiny, text="T", textcolor=color.black)
plotshape(testShort, title="Test Short", style=shape.circle, location=location.abovebar,
     color=color.new(color.red, 0), size=size.tiny, text="T", textcolor=color.white)

var float testHi = na
var float testLo = na
if testLong
    testHi := high
    testLo := low
if testShort
    testHi := high
    testLo := low

useHi = na(testHi) ? hiPush : testHi
useLo = na(testLo) ? loPush : testLo

buf   = entryBufPip * pipSize
slBuf = slBufPip    * pipSize

longEntry  = useHi + buf
shortEntry = useLo - buf

// Calculate crossover/crossunder properly for strategy
longCross  = ta.crossover(high, longEntry)
shortCross = ta.crossunder(low, shortEntry)

// Entry conditions - using crossover logic like working strategy
goLong  = waitTest and longDir and longCross
goShort = waitTest and (not longDir) and shortCross

slLong  = (na(testLo) ? loPush : testLo) - slBuf
slShort = (na(testHi) ? hiPush : testHi) + slBuf

// Bigger TPs to cover commission
tp1L = longEntry  + pipSize * tpMultiplier
tp1S = shortEntry - pipSize * tpMultiplier

// ===== FULL MARGIN STRATEGY LOGIC =====
getFullMarginQty(entryPrice, stopPrice) =>
    if riskPercent >= 100
        // Full margin calculation
        accountValue = strategy.equity
        priceRisk = math.abs(entryPrice - stopPrice)
        maxQty = math.floor(accountValue / (priceRisk * 0.1))
        math.max(1, maxQty)
    else
        riskAmount = strategy.equity * riskPercent / 100
        priceRisk = math.abs(entryPrice - stopPrice)
        math.max(1, math.floor(riskAmount / priceRisk))

// Entry logic
if (goLong and strategy.position_size == 0)
    qty = getFullMarginQty(longEntry, slLong)
    strategy.entry("Long", strategy.long, qty=qty, comment="PTG Long ZERO")
    strategy.exit("Long Exit", "Long", limit=tp1L, stop=slLong, comment="Long Exit")

if (goShort and strategy.position_size == 0)
    qty = getFullMarginQty(shortEntry, slShort)
    strategy.entry("Short", strategy.short, qty=qty, comment="PTG Short ZERO")
    strategy.exit("Short Exit", "Short", limit=tp1S, stop=slShort, comment="Short Exit")

// Reset waitTest
if (goLong or goShort) or (win and (bar_index - iPush) == testBars)
    waitTest := false
    testHi := na
    testLo := na

// ===== VISUALIZATION =====
plotshape(goLong,  title="GO Long",  style=shape.labelup,   location=location.belowbar,
     color=color.new(color.lime, 0), text="ZERO↑", textcolor=color.black, size=size.small)
plotshape(goShort, title="GO Short", style=shape.labeldown, location=location.abovebar,
     color=color.new(color.red, 0),  text="ZERO↓", textcolor=color.white, size=size.small)

plot(goLong  ? slLong : na, title="SL Long",  style=plot.style_circles, color=color.orange)
plot(goShort ? slShort: na, title="SL Short", style=plot.style_circles, color=color.orange)
plot(goLong  ? longEntry  : na, title="Entry Long",  style=plot.style_linebr, color=color.green)
plot(goShort ? shortEntry : na, title="Entry Short", style=plot.style_linebr, color=color.maroon)
plot(goLong  ? tp1L : na, title="TP Long", style=plot.style_linebr, color=color.lime)
plot(goShort ? tp1S: na, title="TP Short", style=plot.style_linebr, color=color.red)

// ===== STATS TABLE =====
var table statsTable = table.new(position.top_right, 2, 7, bgcolor=color.white, border_width=1)
if barstate.islast
    winRate = strategy.closedtrades > 0 ? strategy.wintrades / strategy.closedtrades * 100 : 0
    avgCommission = strategy.closedtrades > 0 ? strategy.netprofit - strategy.grossprofit + strategy.grossloss : 0
    
    table.cell(statsTable, 0, 0, "Exness Zero", text_color=color.white, bgcolor=color.purple, text_size=size.small)
    table.cell(statsTable, 1, 0, "Stats", text_color=color.white, bgcolor=color.purple, text_size=size.small)
    
    table.cell(statsTable, 0, 1, "Total Trades", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 1, str.tostring(strategy.closedtrades), text_color=color.black, text_size=size.tiny)
    
    table.cell(statsTable, 0, 2, "Win Rate", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 2, str.tostring(winRate, "#.#") + "%", text_color=color.black, text_size=size.tiny)
    
    table.cell(statsTable, 0, 3, "Net P&L", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 3, str.tostring(strategy.netprofit, "#.##"), text_color=strategy.netprofit > 0 ? color.green : color.red, text_size=size.tiny)
    
    table.cell(statsTable, 0, 4, "Commissions", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 4, str.tostring(avgCommission, "#.##"), text_color=color.red, text_size=size.tiny)
    
    table.cell(statsTable, 0, 5, "Risk/Trade", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 5, str.tostring(riskPercent, "#") + "%", text_color=color.red, text_size=size.tiny)
    
    table.cell(statsTable, 0, 6, "Account Type", text_color=color.black, text_size=size.tiny)
    table.cell(statsTable, 1, 6, "Zero ($0.35)", text_color=color.orange, text_size=size.tiny)
