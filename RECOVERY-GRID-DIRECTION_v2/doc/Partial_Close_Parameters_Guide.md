# Partial Close Parameters Guide

## üìö Overview

Partial Close l√† feature gi√∫p gi·∫£m drawdown b·∫±ng c√°ch ƒë√≥ng **m·ªôt ph·∫ßn** positions c·ªßa basket ƒëang thua l·ªó khi c√≥ d·∫•u hi·ªáu retest (gi√° quay ƒë·∫ßu).

---

## üéõÔ∏è Input Parameters Explained

### 1. **InpPcEnabled** (bool, default: `false`)
**M√¥ t·∫£**: B·∫≠t/t·∫Øt to√†n b·ªô Partial Close feature.

**C√°ch d√πng**:
- `false`: T·∫Øt PC ‚Üí EA ho·∫°t ƒë·ªông nh∆∞ c≈© (ch·ªâ ƒë√≥ng khi full TP)
- `true`: B·∫≠t PC ‚Üí EA s·∫Ω ƒë√≥ng t·ª´ng ph·∫ßn loser khi c√≥ c∆° h·ªôi

**Khuy·∫øn ngh·ªã**:
- Backtest v·ªõi `false` ƒë·ªÉ c√≥ baseline
- Test v·ªõi `true` ƒë·ªÉ so s√°nh drawdown reduction

---

### 2. **InpPcRetestAtr** (double, default: `0.8`)
**M√¥ t·∫£**: H·ªá s·ªë ATR ƒë·ªÉ x√°c ƒë·ªãnh "retest ƒë·ªß s√¢u".

**C√¥ng th·ª©c**:
```
retest_distance = |furthest_entry_price - current_price|
trigger_threshold = InpPcRetestAtr √ó ATR

N·∫øu retest_distance >= trigger_threshold ‚Üí cho ph√©p PC
```

**V√≠ d·ª•**:
- ATR = 50 pips
- `InpPcRetestAtr = 0.8` ‚Üí c·∫ßn retest √≠t nh·∫•t 40 pips
- Loser SELL c√≥ entry xa nh·∫•t l√† 1.1050
- Gi√° hi·ªán t·∫°i: 1.1010 ‚Üí retest = 40 pips ‚Üí **trigger PC**

**T√°c ƒë·ªông**:
- **TƒÉng (0.8 ‚Üí 1.2)**: PC √≠t h∆°n, ch·ªù retest s√¢u h∆°n ‚Üí √≠t risk ƒë√≥ng s·ªõm
- **Gi·∫£m (0.8 ‚Üí 0.5)**: PC nhi·ªÅu h∆°n, trigger s·ªõm ‚Üí gi·∫£m DD t·ªët h∆°n nh∆∞ng c√≥ th·ªÉ miss profit

**Khuy·∫øn ngh·ªã**: `0.6-0.8` cho balance t·ªët

---

### 3. **InpPcSlopeHysteresis** (double, default: `0.0002`)
**M√¥ t·∫£**: Hysteresis cho slope momentum (hi·ªán t·∫°i ch∆∞a implement ƒë·∫ßy ƒë·ªß).

**T√°c ƒë·ªông**: Reserved cho future enhancement (momentum-based trigger).

**Khuy·∫øn ngh·ªã**: Gi·ªØ m·∫∑c ƒë·ªãnh `0.0002`

---

### 4. **InpPcMinProfitUsd** (double, default: `1.5`)
‚≠ê **QUAN TR·ªåNG** - Tham s·ªë n√†y ·∫£nh h∆∞·ªüng l·ªõn ƒë·∫øn performance!

**M√¥ t·∫£**: PnL t·ªëi thi·ªÉu (USD) c·ªßa nh√≥m tickets g·∫ßn gi√° ƒë·ªÉ cho ph√©p PC.

**C√°ch ho·∫°t ƒë·ªông**:
1. EA s·∫Øp x·∫øp t·∫•t c·∫£ positions theo kho·∫£ng c√°ch t·ªõi gi√° (g·∫ßn nh·∫•t tr∆∞·ªõc)
2. T√≠nh t·ªïng PnL c·ªßa `InpPcMaxTickets` tickets g·∫ßn nh·∫•t
3. N·∫øu `total_PnL >= InpPcMinProfitUsd` ‚Üí cho ph√©p PC

**V√≠ d·ª•**:
- Loser SELL c√≥ 5 tickets:
  - Ticket A (g·∫ßn nh·∫•t): PnL = -2.0
  - Ticket B: PnL = +1.0
  - Ticket C: PnL = +3.0
  - Ticket D: PnL = -5.0
  - Ticket E (xa nh·∫•t): PnL = -8.0

- `InpPcMaxTickets = 3`, `InpPcMinProfitUsd = 1.0`
- Check 3 tickets g·∫ßn nh·∫•t: A + B + C = -2.0 + 1.0 + 3.0 = **+2.0 USD**
- 2.0 >= 1.0 ‚Üí **Allow PC** ‚úÖ

**Backtest Results**:
- `MinProfitUsd = 1.0` (Image #1): Balance 12116, DD moderate
- `MinProfitUsd = 5.0` (Image #2): Balance 12170, DD slightly higher

**T√°c ƒë·ªông**:
- **TƒÉng (1.5 ‚Üí 5.0)**:
  - PC √≠t h∆°n (ch·ªù profitable tickets nhi·ªÅu h∆°n)
  - Gi·ªØ profit t·ªët h∆°n
  - DD c√≥ th·ªÉ cao h∆°n

- **Gi·∫£m (1.5 ‚Üí 1.0)**:
  - PC nhi·ªÅu h∆°n (d·ªÖ trigger)
  - Gi·∫£m DD t·ªët h∆°n
  - C√≥ th·ªÉ m·∫•t profit s·ªõm

**Khuy·∫øn ngh·ªã**:
- Conservative (√≠t PC): `2.0-3.0`
- Balanced: `1.0-1.5`
- Aggressive (nhi·ªÅu PC): `0.5-1.0`

---

### 5. **InpPcCloseFraction** (double, default: `0.30`)
**M√¥ t·∫£**: T·ª∑ l·ªá t·ªëi ƒëa c·ªßa t·ªïng lot loser ƒë∆∞·ª£c ƒë√≥ng m·ªói l·∫ßn PC.

**V√≠ d·ª•**:
- Loser c√≥ t·ªïng lot: 1.0
- `InpPcCloseFraction = 0.30` ‚Üí ƒë√≥ng t·ªëi ƒëa 0.30 lot
- Nh∆∞ng c√≤n gi·ªõi h·∫°n b·ªüi `InpPcMaxTickets` v√† `InpPcMinLotsRemain`

**T√°c ƒë·ªông**:
- **TƒÉng (0.30 ‚Üí 0.50)**: ƒê√≥ng nhi·ªÅu h∆°n m·ªói l·∫ßn ‚Üí gi·∫£m DD nhanh h∆°n
- **Gi·∫£m (0.30 ‚Üí 0.20)**: ƒê√≥ng √≠t h∆°n ‚Üí b·∫£o to√†n kh·∫£ nƒÉng recovery

**Khuy·∫øn ngh·ªã**: `0.25-0.35`

---

### 6. **InpPcMaxTickets** (int, default: `3`)
**M√¥ t·∫£**: S·ªë ticket t·ªëi ƒëa ƒë√≥ng trong m·ªôt l·∫ßn PC.

**V√≠ d·ª•**:
- Loser c√≥ 10 tickets
- `InpPcMaxTickets = 3` ‚Üí ch·ªâ ƒë√≥ng t·ªëi ƒëa 3 tickets g·∫ßn gi√° nh·∫•t

**T√°c ƒë·ªông**:
- **TƒÉng (3 ‚Üí 5)**: ƒê√≥ng nhi·ªÅu tickets ‚Üí gi·∫£m DD m·∫°nh h∆°n
- **Gi·∫£m (3 ‚Üí 2)**: ƒê√≥ng √≠t tickets ‚Üí conservative h∆°n

**Khuy·∫øn ngh·ªã**: `2-4` tickets

---

### 7. **InpPcCooldownBars** (int, default: `10`)
**M√¥ t·∫£**: S·ªë bars t·ªëi thi·ªÉu gi·ªØa hai l·∫ßn PC.

**L√Ω do**: Tr√°nh spam PC li√™n t·ª•c trong c√πng m·ªôt retest wave.

**V√≠ d·ª•**:
- Timeframe M15, `InpPcCooldownBars = 10` ‚Üí cooldown = 150 ph√∫t = 2.5 gi·ªù
- PC l·∫ßn 1 l√∫c 10:00 ‚Üí PC l·∫ßn 2 s·ªõm nh·∫•t l√∫c 12:30

**T√°c ƒë·ªông**:
- **TƒÉng (10 ‚Üí 20)**: PC √≠t h∆°n, cooldown l√¢u h∆°n
- **Gi·∫£m (10 ‚Üí 5)**: PC nhi·ªÅu h∆°n, cooldown ng·∫Øn

**Khuy·∫øn ngh·ªã**: `8-15` bars

---

### 8. **InpPcGuardBars** (int, default: `6`)
**M√¥ t·∫£**: S·ªë bars ph·∫£i ch·ªù tr∆∞·ªõc khi cho ph√©p reseed v√πng v·ª´a ƒë√≥ng.

**L√Ω do**: Sau khi PC, EA cancel pending orders g·∫ßn gi√°. Guard bars ngƒÉn bot m·ªü l·∫°i ngay v√πng ƒë√≥ (tr√°nh "ƒë√≥ng r·ªìi m·ªü l·∫°i" v√¥ √≠ch).

**V√≠ d·ª•**:
- PC ƒë√≥ng tickets ·ªü v√πng 1.1020-1.1030
- Guard active trong 6 bars (90 ph√∫t n·∫øu M15)
- Trong th·ªùi gian n√†y, bot KH√îNG reseed pending ·ªü v√πng ƒë√£ ƒë√≥ng

**T√°c ƒë·ªông**:
- **TƒÉng (6 ‚Üí 10)**: Guard l√¢u h∆°n, tr√°nh re-enter s·ªõm
- **Gi·∫£m (6 ‚Üí 3)**: Guard ng·∫Øn, cho ph√©p reseed nhanh h∆°n

**Khuy·∫øn ngh·ªã**: `5-8` bars

---

### 9. **InpPcPendingGuardMult** (double, default: `0.5`)
**M√¥ t·∫£**: H·ªá s·ªë nh√¢n spacing ƒë·ªÉ x√°c ƒë·ªãnh v√πng cancel pending sau PC.

**C√¥ng th·ª©c**:
```
guard_offset = spacing √ó InpPcPendingGuardMult
cancel_range = [current_price - guard_offset, current_price + guard_offset]
```

**V√≠ d·ª•**:
- Spacing = 30 pips
- `InpPcPendingGuardMult = 0.5` ‚Üí guard_offset = 15 pips
- Gi√° PC: 1.1020 ‚Üí cancel pending trong [1.1005, 1.1035]

**T√°c ƒë·ªông**:
- **TƒÉng (0.5 ‚Üí 1.0)**: Cancel v√πng r·ªông h∆°n
- **Gi·∫£m (0.5 ‚Üí 0.3)**: Cancel v√πng h·∫πp h∆°n

**Khuy·∫øn ngh·ªã**: `0.4-0.6`

---

### 10. **InpPcGuardExitAtr** (double, default: `0.6`)
**M√¥ t·∫£**: H·ªá s·ªë ATR ƒë·ªÉ guard expire s·ªõm n·∫øu gi√° di chuy·ªÉn xa.

**C√°ch ho·∫°t ƒë·ªông**:
- Guard b√¨nh th∆∞·ªùng expire sau `InpPcGuardBars` bars
- Nh∆∞ng n·∫øu gi√° di chuy·ªÉn >= `InpPcGuardExitAtr √ó ATR` ‚Üí guard expire ngay

**V√≠ d·ª•**:
- ATR = 50 pips, `InpPcGuardExitAtr = 0.6` ‚Üí threshold = 30 pips
- PC t·∫°i 1.1020
- N·∫øu gi√° ch·∫°y t·ªõi 1.1050 (30 pips) ‚Üí guard expire ngay ‚Üí cho ph√©p reseed

**T√°c ƒë·ªông**:
- **TƒÉng (0.6 ‚Üí 1.0)**: C·∫ßn gi√° ch·∫°y xa h∆°n m·ªõi expire
- **Gi·∫£m (0.6 ‚Üí 0.4)**: Expire d·ªÖ h∆°n

**Khuy·∫øn ngh·ªã**: `0.5-0.7`

---

### 11. **InpPcMinLotsRemain** (double, default: `0.20`)
**M√¥ t·∫£**: Lot t·ªëi thi·ªÉu ph·∫£i c√≤n l·∫°i sau PC (kh√¥ng ƒë√≥ng h·∫øt basket).

**L√Ω do**: Gi·ªØ l·∫°i m·ªôt ph·∫ßn ƒë·ªÉ n·∫øu gi√° bounce l·∫°i, c√≤n c√≥ positions ƒë·ªÉ recovery.

**V√≠ d·ª•**:
- Loser c√≥ 1.0 lot
- `InpPcMinLotsRemain = 0.20` ‚Üí ƒë√≥ng t·ªëi ƒëa 0.80 lot

**T√°c ƒë·ªông**:
- **TƒÉng (0.20 ‚Üí 0.40)**: Gi·ªØ l·∫°i nhi·ªÅu h∆°n ‚Üí b·∫£o to√†n recovery potential
- **Gi·∫£m (0.20 ‚Üí 0.10)**: ƒê√≥ng nhi·ªÅu h∆°n ‚Üí gi·∫£m DD m·∫°nh h∆°n

**Khuy·∫øn ngh·ªã**: `0.15-0.25`

---

## üìä Backtest Results Analysis

### Test 1: MinProfitUsd = 1.0 (Image #1)
- **Balance**: 12116
- **Drawdown**: Moderate (DD spike ~10.0%)
- **Behavior**: PC trigger nhi·ªÅu h∆°n ‚Üí ƒë√≥ng s·ªõm h∆°n

### Test 2: MinProfitUsd = 5.0 (Image #2)
- **Balance**: 12170 (+0.4%)
- **Drawdown**: Slightly higher (DD spike ~10.8%)
- **Behavior**: PC trigger √≠t h∆°n ‚Üí gi·ªØ profit l√¢u h∆°n

### K·∫øt lu·∫≠n t·ª´ backtest:
`MinProfitUsd = 5.0` cho k·∫øt qu·∫£ **t·ªët h∆°n m·ªôt ch√∫t** trong tr∆∞·ªùng h·ª£p n√†y:
- Balance cao h∆°n 54 USD (+0.4%)
- DD tƒÉng nh·∫π nh∆∞ng acceptable
- √çt PC kh√¥ng c·∫ßn thi·∫øt ‚Üí gi·ªØ profit t·ªët h∆°n

---

## üéØ Recommended Settings

### **Conservative** (∆Øu ti√™n gi·∫£m DD):
```
InpPcEnabled           = true
InpPcRetestAtr         = 0.6    // Trigger s·ªõm
InpPcMinProfitUsd      = 1.0    // D·ªÖ trigger
InpPcCloseFraction     = 0.35   // ƒê√≥ng nhi·ªÅu
InpPcMaxTickets        = 4
InpPcCooldownBars      = 8
InpPcGuardBars         = 6
InpPcPendingGuardMult  = 0.5
InpPcGuardExitAtr      = 0.6
InpPcMinLotsRemain     = 0.25   // Gi·ªØ l·∫°i nhi·ªÅu
```

### **Balanced** (Balance gi·ªØa DD v√† profit):
```
InpPcEnabled           = true
InpPcRetestAtr         = 0.8    // Default
InpPcMinProfitUsd      = 2.0    // Moderate
InpPcCloseFraction     = 0.30
InpPcMaxTickets        = 3
InpPcCooldownBars      = 10
InpPcGuardBars         = 6
InpPcPendingGuardMult  = 0.5
InpPcGuardExitAtr      = 0.6
InpPcMinLotsRemain     = 0.20
```

### **Aggressive** (∆Øu ti√™n profit):
```
InpPcEnabled           = true
InpPcRetestAtr         = 1.0    // Ch·ªù retest s√¢u
InpPcMinProfitUsd      = 5.0    // Kh√≥ trigger
InpPcCloseFraction     = 0.25   // ƒê√≥ng √≠t
InpPcMaxTickets        = 2
InpPcCooldownBars      = 15
InpPcGuardBars         = 8
InpPcPendingGuardMult  = 0.4
InpPcGuardExitAtr      = 0.7
InpPcMinLotsRemain     = 0.15   // Gi·ªØ l·∫°i √≠t
```

---

## üîç How to Optimize

### Step 1: Baseline
Test v·ªõi `InpPcEnabled = false` ƒë·ªÉ c√≥ baseline:
- Note final balance
- Note max DD
- Note DD duration

### Step 2: Enable v·ªõi Default
Test v·ªõi all defaults (`InpPcEnabled = true`):
- So s√°nh balance vs baseline
- So s√°nh DD reduction
- Observe PC frequency trong logs

### Step 3: Tune Key Params
Focus v√†o 3 params quan tr·ªçng nh·∫•t:
1. **InpPcMinProfitUsd** (1.0, 2.0, 5.0)
2. **InpPcRetestAtr** (0.6, 0.8, 1.0)
3. **InpPcCloseFraction** (0.25, 0.30, 0.35)

### Step 4: Fine-tune
ƒêi·ªÅu ch·ªânh cooldown/guard params n·∫øu c·∫ßn:
- N·∫øu PC qu√° nhi·ªÅu ‚Üí tƒÉng cooldown
- N·∫øu re-enter li√™n t·ª•c ‚Üí tƒÉng guard

---

## üìù Logs to Watch

Khi backtest, check logs:
```
[PartialClose] tickets=3 profit=2.45 price=1.10234
```

**Ideal frequency**:
- 1-3 PCs per major trend reversal
- Kh√¥ng qu√° 5 PCs/day

**Red flags**:
- PC m·ªói 30 ph√∫t ‚Üí cooldown qu√° ng·∫Øn
- Kh√¥ng c√≥ PC n√†o trong 1 tu·∫ßn ‚Üí params qu√° strict

---

## üéì Summary

**Top 3 params c·∫ßn hi·ªÉu**:
1. **InpPcMinProfitUsd**: ƒêi·ªÅu khi·ªÉn khi n√†o trigger (th·∫•p = nhi·ªÅu PC)
2. **InpPcRetestAtr**: ƒêi·ªÅu khi·ªÉn retest ph·∫£i s√¢u bao nhi√™u
3. **InpPcCloseFraction**: ƒêi·ªÅu khi·ªÉn ƒë√≥ng bao nhi√™u m·ªói l·∫ßn

**Rule of thumb**:
- Mu·ªën gi·∫£m DD ‚Üí gi·∫£m MinProfitUsd, gi·∫£m RetestAtr, tƒÉng CloseFraction
- Mu·ªën tƒÉng profit ‚Üí tƒÉng MinProfitUsd, tƒÉng RetestAtr, gi·∫£m CloseFraction

**T·ª´ backtest results**:
- `MinProfitUsd = 5.0` cho balance cao h∆°n (+0.4%)
- DD tƒÉng nh·∫π nh∆∞ng acceptable
- Recommend: Start v·ªõi `5.0`, gi·∫£m xu·ªëng `2.0` n·∫øu DD v·∫´n cao

---

**Document Version**: 1.0
**Last Updated**: 2025-10-01
**Author**: Recovery Grid Direction v2 Team
